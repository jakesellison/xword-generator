---
title: "main"
output: html_document
---
```{r}
library(tidyverse)
library(qdapDictionaries)
library(profvis)
library(snow)
```

```{r}
#compute the score of a word by the weighting of the table
score_word <- function(word,freq){
  char_list <- strsplit(word,"")[[1]]
  score <- c(down1 = 0, down2 = 0, down3 = 0, down4 = 0)
  for (i in 1:length(char_list)){
    for (j in 1:length(score)) {
      score[i] <- score [i] + freq[[i]][match(char_list[[j]], freq[[i]]$x),2]
    }
  }
  return(score)
}

#score every word based on frequency of letter positions
scorecard_init <- function(dict, freq){
  scorecard <- data.frame(cbind(dict, do.call(rbind, data.frame(lapply(dict, score_word, freq)))))
  rownames(scorecard) <- NULL
  colnames(scorecard) <- c('word','down1','down2','down3','down4')
  scorecard$word <- as.character(scorecard$word)
  scorecard <- scorecard %>% mutate_at(c(2:5),function(x){as.numeric(as.character(x))})
  return(scorecard)
}

#initialize the dictionary
dict_init <- function(){
  full_dict <- qdapDictionaries::DICTIONARY
  dict3 <- mutate(full_dict, nchar = nchar(word)) %>% 
    filter(nchar == 4)
  dict <- dict3$word
  return(dict)
}

#for each column in the puzzle, create a dict list ordered by score
gen_score_dict <- function(scorecard) {
  scored_dict <- c()
  for(i in 1:(ncol(scorecard)-1)) {
    score_col <- data.frame(word = scorecard[,1], score = scorecard[,i+1]) %>% 
      arrange(desc(score))
    scored_dict <- append(scored_dict,list(as.character(score_col[,1])))
  }
  return(scored_dict)
}

dict_avail_words <- function(clues, score_dict) {
  avail_words <- score_dict[[1]][!score_dict[[1]] %in% clues]
  return(avail_words)
}
 
#generate a frequency table showing how likely a given word is to appear in a square
freq_init <- function(dict){
  freq <- t(data.frame(lapply(dict, strsplit, "")))
  freq <- apply(freq, 2, function(x){data.frame(table(x)[order(table(x), decreasing = TRUE)])})
  return(freq)
}
#initialize the puzzle
puzzle_init <- function(){
  puzzle <- data.frame(down1 = rep(NA,4), down2 = rep(NA,4), down3 = rep(NA,4), down4 =  rep(NA,4))
  return(puzzle)
}

#find the next word to be added to the puzzle using the frequency table
#look for the best word where the frequency serves both across and down directions on puzzle
find_word <- function(clues,stack_dict,depth){
  puzzle <- puzzle_init()
  for(i in 1:(depth-1)){
    puzzle <- write_word(clues[i],puzzle,i)
  }
  for(i in 1:length(stack_dict)) {
    try <- test_puzzle(stack_dict[i],stack_dict,puzzle,depth)
    if(!FALSE %in% try){
      return(c(stack_dict[i],list(stack_dict[(i+1):length(stack_dict)])))
    }
  }
  return(c(FALSE,FALSE))
}

#look through the across rows and make sure that the puzzle is still viable
test_puzzle <- function(clue, avail_words, puzzle, depth){
  avail_words <- sapply(avail_words, shorten_word, depth)
  puzzle <- write_word(clue,puzzle,depth)
  across_list <- apply(puzzle, 1, function(x){substr(paste(unlist(x), collapse=''),1,depth)})
  sapply(across_list, test_word, avail_words)
}

test_word <- function(x, avail_words){
  x %in% avail_words
}

shorten_word <- function(x,depth){substr(x,1,depth)}

#write a word into the puzzle at a given index
write_word <- function(word, puzzle, depth){
  word <- strsplit(word, "")[[1]]
  puzzle[,depth] <- word
  return(puzzle)
}

```

```{r}
dict_all <- dict_init()
freq <- freq_init(dict_all)
scorecard <- scorecard_init(dict_all,freq)
score_dict <- gen_score_dict(scorecard)
```

```{r}
# for testing...
seed <- 'star'
```

```{r}
main <- function(seed,score_dict){
  #browser()
  clues <- c(seed)
  stack_dict <- score_dict
  while(length(clues) != 4){
    message(paste(length(stack_dict[[depth]])))
    depth <- length(clues)+1
    stack_dict[[depth]] <- stack_dict[[depth]][!stack_dict[[depth]] %in% clues]
    search_tpl <- find_word(clues,stack_dict[[depth]],depth)
    if(search_tpl[[1]] == FALSE){
      clues <- clues[1:length(clues)-1]
      stack_dict[[depth]] <- score_dict[[depth]]
      depth <- depth-1
    } else {
      stack_dict[[depth]] <- search_tpl[[2]]
      clues <- append(clues, search_tpl[[1]])
    }
  }
  return(clues)
}
```

```{r}
profvis({
  clues <-  main(seed,score_dict)
})
```


```{r}
puzzle <- puzzle_init()
clues <- c('sale','area')
depth <- 3
for(i in 1:(depth-1)){
    puzzle <- write_word(clues[i],puzzle,i)
}
clue <- 'hmph'
puzzle <- write_word(clue,puzzle,depth)
puzzle[is.na(puzzle)] <- '.'
avail_words <- score_dict[[1]]

shorten_word <- function(x,depth){substr(x,1,depth)}
avail_words_shorter <- sapply(avail_words, shorten_word, depth)

regex_list <- apply(puzzle, 1, function(x){regex(paste(unlist(x), collapse=''))})
across_list <- apply(puzzle, 1, function(x){substr(paste(unlist(x), collapse=''),1,depth)})

profvis({
  #regex
  test_word <- function(x, avail_words){
    matches <- sapply(avail_words,stringi::stri_detect_regex,x)
    pass <- ifelse(length(matches[matches == TRUE]) > 0, TRUE, FALSE)
  }
  lapply(regex_list, test_word, avail_words)
  
  #shorter words
  test_word_shorter <- function(x, avail_words_shorter){
    x %in% avail_words_shorter
  }
  x<-sapply(across_list, test_word_shorter, avail_words_shorter)
})
```


```{r}
xword <-puzzle_init()
for(i in 1:length(clues)){
  xword <- write_word(clues[i], xword, i)
}
xword
```