---
title: "main"
output: html_document
---
```{r}
library(tidyverse)
library(qdapDictionaries)
library(profvis)
library(gtools)
```

```{r}
#compute the score of a word by the weighting of the table
score_word <- function(word,freq){
  char_list <- strsplit(word,"")[[1]]
  score<-c(rep(0,length(char_list)))
  for (i in 1:length(char_list)){
    for (j in 1:length(char_list)) {
      score[i] <- score[i] + freq[[i]][match(char_list[[j]], freq[[i]]$x),2]
    }
  }
  return(score)
}

#score every word based on frequency of letter positions
scorecard_init <- function(dict, freq, dim){
  scorecard <- data.frame(cbind(dict, do.call(rbind, data.frame(lapply(dict, score_word, freq)))))
  #rownames(scorecard) <- NULL
  #scorecard$word <- as.character(scorecard$word)
  scorecard <- scorecard %>% mutate_at(c(1:dim+1),function(x){as.numeric(as.character(x))})
  return(scorecard)
}

#initialize the dictionary
dict_init <- function(dim){
  full_dict <- qdapDictionaries::DICTIONARY
  dict5 <- mutate(full_dict, nchar = nchar(word)) %>% 
    filter(nchar == dim)
  dict <- dict5$word
  dict <- tolower(dict)
  dict <- dict[stringi::stri_detect_regex(dict,"^[a-z]+$")]
  return(dict)
}

#for each column in the puzzle, create a dict list ordered by score
gen_score_dict <- function(scorecard) {
  scored_dict <- c()
  for(i in 1:(ncol(scorecard)-1)) {
    score_col <- data.frame(word = scorecard[,1], score = scorecard[,i+1]) %>% 
      arrange(desc(score))
    scored_dict <- append(scored_dict,list(as.character(score_col[,1])))
  }
  return(lapply(scored_dict, function(x){lapply(x, function(y){strsplit(y,"")[[1]]})}))
}
 
#generate a frequency table showing how likely a given word is to appear in a square
freq_init <- function(dict){
  freq <- t(data.frame(lapply(dict, strsplit, "")))
  freq <- apply(freq, 2, function(x){data.frame(table(x)[order(table(x), decreasing = TRUE)])})
  return(freq)
}
```


```{r}
find_word <- function(clue_matrix,stack_dict,dim,clues){
  for(i in 1:length(stack_dict)){
    if(paste(stack_dict[[i]],collapse='') %in% clues){next}
    subtract_frag_array(stack_dict[[i]],dim) #remove candidate word from frag_array
    try <- apply(cbind(clue_matrix,stack_dict[[i]]), 1, test_word, dim)
    if(!FALSE %in% try){
      return(list(stack_dict[i],list(stack_dict[(i+1):length(stack_dict)]),TRUE))
    } else {
      add_frag_array(stack_dict[[i]],dim) #test failed, repair frag_array
    }
  }
  return(c(FALSE,FALSE,FALSE))
}

test_word <- function(frag,dim){
  return(frag_array[matrix(c(sapply(frag,char_to_num),rep(1,dim))[1:dim], nrow = 1, ncol = dim)] > 0)
}
```

```{r}
#experimenting with memory for time savings
explode_dict <- function(dict_all){
  do.call(c,lapply(dict_all, explode_word))
}
                   
explode_word <- function(x){
  split_out <- c()
  for (i in 1:nchar(x)){
    split_out <- append(split_out, substr(x,1,i))
  }
  return(split_out)
}

char_to_num <- function(x){
  if(x == ""){return(1)}
  as.numeric(charToRaw(x))-95
}

populate_frag_array <- function(frags, frag_array, dim) {
  for (frag in frags) {
    dim_index <- sapply(strsplit(frag,"")[[1]], char_to_num)
    dim_matrix <- matrix(c(dim_index,rep(1,dim))[1:dim], nrow = 1, ncol = dim)
    #index array using a matrix w/1 row, dim # of cols, and each val is an index in the dimension
    frag_array[dim_matrix] <- frag_array[dim_matrix] + 1
  }
  return(frag_array)
}

#remove a word and all of its frags from the frag_array
## Not working because I decrement for a given level in the stack, but when all of those words are returned as viable on the next level, not all are restored.
subtract_frag_array <- function(clue, dim) {
  for(i in 1:length(clue)){
    dim_matrix <- matrix(c(sapply(clue[1:i],char_to_num),rep(1,dim))[1:dim], nrow = 1, ncol = dim)
    frag_array[dim_matrix] <<- frag_array[dim_matrix] - 1
  }
}

add_frag_array <- function(clue, dim) {
  for(i in 1:length(clue)){
    dim_matrix <- matrix(c(sapply(clue[1:i],char_to_num),rep(1,dim))[1:dim], nrow = 1, ncol = dim)
    frag_array[dim_matrix] <<- frag_array[dim_matrix] + 1
  }
}

reset_frag_array <- function(clue_matrix, dim) {
  frag_array <- mstr_frag_array
  for (i in 1:(ncol(clue_matrix)-1)) {
    subtract_frag_array(clue_matrix[,i],dim)
  }
}
```

```{r}
main <- function(seed, dim){
  clue_matrix <- matrix(strsplit(seed,"")[[1]],nrow=dim,ncol=1,byrow = FALSE)
  clues <- seed
  profiling_i <- 0
  while(length(clues) != dim){
    profiling_i <- profiling_i + 1
    if(profiling_i == 5){return(TRUE)}
    depth <- length(clues) + 1
    if(depth == dim){
      message(paste(length(stack_dict[[2]])))
    }
    search_tpl <- find_word(clue_matrix,stack_dict[[depth]],dim,clues)
    if(search_tpl[[3]][[1]] == FALSE & depth == 2){
      return(FALSE)
    } else if (search_tpl[[3]][[1]] == FALSE) {
      stack_dict[[depth]] <- score_dict[[depth]]
      depth <- depth-1
      clues <- clues[1:depth-1]
      reset_frag_array(clue_matrix, dim)
      clue_matrix <- clue_matrix[,c(1:(ncol(clue_matrix)-1))]
    } else {
      stack_dict[[depth]] <- search_tpl[[2]][[1]]
      clue_matrix <- cbind(clue_matrix, search_tpl[[1]][[1]])
      clues <- append(clues, paste(search_tpl[[1]][[1]],collapse=''))
    }
  }
  return(clue_matrix)
}
```

```{r}
# global vars...

init_global_vars <- function(seed,dim){

  dict_all <<- dict_init(dim)
  freq <<- freq_init(dict_all)
  scorecard <<- scorecard_init(dict_all,freq,dim)
  score_dict <<- gen_score_dict(scorecard)
  stack_dict <<- score_dict

  frags <<- explode_dict(dict_all)
  mstr_frag_array <<- array(rep(0,27^dim),rep(27,dim))
  mstr_frag_array <<- populate_frag_array(frags, mstr_frag_array, dim)
  frag_array <<- mstr_frag_array
  subtract_frag_array(strsplit(seed,"")[[1]],dim)
}

# for testing...

seed <- 'spasm'

init_global_vars(seed,5)
start_time <- Sys.time()
main(seed, 5)
end_time <- Sys.time()
end_time - start_time
```

```{r}
profvis({
  dim <-5
  clue_matrix <- matrix(strsplit(seed,"")[[1]],nrow=dim,ncol=1,byrow = FALSE)
  clues <- seed
  profiling_i <- 0
  while(length(clues) != dim){
    profiling_i <- profiling_i + 1
    if(profiling_i == 5){break}
    depth <- length(clues) + 1
    if(depth == dim){
      message(paste(length(stack_dict[[2]])))
    }
    
    ### FIND WORD FUN
    t_stack_dict <- stack_dict[[depth]]
    search_tpl <- c()
    for(i in 1:length(t_stack_dict)){
      if(paste(t_stack_dict[[i]],collapse='') %in% clues){next}
      subtract_frag_array(t_stack_dict[[i]],dim) #remove candidate word from frag_array
      
      # ### TEST WORD FUN
      # frag_mat <- matrix(c(sapply(frag,char_to_num),rep(1,dim))[1:dim], nrow = 1, ncol = dim)
      # frag_array[frag_mat] > 0

      try <- apply(cbind(clue_matrix,t_stack_dict[[i]]), 1, test_word, dim)
      ### END
      if(!FALSE %in% try){
        search_tpl <- list(t_stack_dict[i],list(t_stack_dict[(i+1):length(t_stack_dict)]),TRUE)
        break
      } else {
        add_frag_array(t_stack_dict[[i]],dim) #test failed, repair frag_array
      }
    }
    if(length(search_tpl)==0){search_tpl <- c(FALSE,FALSE,FALSE)}
    ### END
    
    if(search_tpl[[3]][[1]] == FALSE & depth == 2){
      return(FALSE)
    } else if (search_tpl[[3]][[1]] == FALSE) {
      stack_dict[[depth]] <- score_dict[[depth]]
      depth <- depth-1
      clues <- clues[1:depth-1]
      reset_frag_array(clue_matrix, dim)
      clue_matrix <- clue_matrix[,c(1:(ncol(clue_matrix)-1))]
    } else {
      stack_dict[[depth]] <- search_tpl[[2]][[1]]
      clue_matrix <- cbind(clue_matrix, search_tpl[[1]][[1]])
      clues <- append(clues, paste(search_tpl[[1]][[1]],collapse=''))
    }
  }
})
```




